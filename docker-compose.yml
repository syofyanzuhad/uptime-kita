version: '3.8'

# ==============================================================================
# Docker Compose for Uptime-Kita
# ==============================================================================
# Usage:
#   Production: docker compose up -d
#   Development: docker compose --profile dev up -d
#   Build: docker compose build
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # Production App Service
  # ----------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        APP_ENV: production
    container_name: uptime-kita-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:80"
    environment:
      - APP_NAME=${APP_NAME:-Uptime-Kita}
      - APP_ENV=${APP_ENV:-production}
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_URL=${APP_URL:-http://localhost}
      - DB_CONNECTION=${DB_CONNECTION:-sqlite}
      - DB_DATABASE=/var/www/html/database/database.sqlite
      - CACHE_DRIVER=${CACHE_DRIVER:-file}
      - SESSION_DRIVER=${SESSION_DRIVER:-file}
      - QUEUE_CONNECTION=${QUEUE_CONNECTION:-database}
    volumes:
      - ./database:/var/www/html/database
      - ./storage/logs:/var/www/html/storage/logs
      - ./storage/app:/var/www/html/storage/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - uptime-kita-network

  # ----------------------------------------------------------------------------
  # Development App Service (with hot reload support)
  # ----------------------------------------------------------------------------
  app-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      args:
        APP_ENV: local
    container_name: uptime-kita-dev
    profiles:
      - dev
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:80"
      - "5173:5173"
    environment:
      - APP_NAME=${APP_NAME:-Uptime-Kita}
      - APP_ENV=local
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=true
      - APP_URL=${APP_URL:-http://localhost}
      - DB_CONNECTION=${DB_CONNECTION:-sqlite}
      - DB_DATABASE=/var/www/html/database/database.sqlite
      - CACHE_DRIVER=file
      - SESSION_DRIVER=file
      - QUEUE_CONNECTION=sync
    volumes:
      - .:/var/www/html
      - /var/www/html/vendor
      - /var/www/html/node_modules
    networks:
      - uptime-kita-network

networks:
  uptime-kita-network:
    driver: bridge
